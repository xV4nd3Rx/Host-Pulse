name: Trivy Repo Scan (no trivy-action)

on:
  push:
    branches: ["main", "master"]
  pull_request:
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  trivy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # (Опционально) кеш базы уязвимостей Trivy, чтобы было быстрее
      - name: Cache Trivy DB
        uses: actions/cache@v4
        with:
          path: .trivycache
          key: trivy-db-${{ runner.os }}-${{ github.run_id }}
          restore-keys: |
            trivy-db-${{ runner.os }}-

      # 1) Vulnerabilities (deps / packages) -> SARIF
      - name: Trivy - vuln scan (fs) -> SARIF
        run: |
          mkdir -p .trivycache
          docker run --rm \
            -v "${PWD}:/work" \
            -v "${PWD}/.trivycache:/root/.cache" \
            -w /work \
            get.trivy.dev/image/trivy:0.68.1 \
            fs \
              --scanners vuln \
              --severity HIGH,CRITICAL \
              --ignore-unfixed \
              --format sarif \
              --output trivy-vuln.sarif \
              .

      - name: Upload SARIF (vuln) to GitHub
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-vuln.sarif
          category: trivy-vuln

      # 2) Secrets -> SARIF
      - name: Trivy - secret scan -> SARIF
        run: |
          mkdir -p .trivycache
          docker run --rm \
            -v "${PWD}:/work" \
            -v "${PWD}/.trivycache:/root/.cache" \
            -w /work \
            get.trivy.dev/image/trivy:0.68.1 \
            fs \
              --scanners secret \
              --format sarif \
              --output trivy-secret.sarif \
              .

      - name: Upload SARIF (secret) to GitHub
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-secret.sarif
          category: trivy-secret

      # 3) IaC misconfigurations -> SARIF (Terraform/K8s/Helm/Dockerfile/GitHub Actions и т.д.)
      - name: Trivy - config scan (IaC) -> SARIF
        run: |
          mkdir -p .trivycache
          docker run --rm \
            -v "${PWD}:/work" \
            -v "${PWD}/.trivycache:/root/.cache" \
            -w /work \
            get.trivy.dev/image/trivy:0.68.1 \
            config \
              --severity HIGH,CRITICAL \
              --format sarif \
              --output trivy-config.sarif \
              .

      - name: Upload SARIF (config) to GitHub
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-config.sarif
          category: trivy-config
