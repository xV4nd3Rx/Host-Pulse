name: Trivy Repo Scan

on:
  push:
    branches: ["main", "master"]
  pull_request:
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  trivy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Trivy (binary)
        shell: bash
        run: |
          set -euo pipefail
          TRIVY_VERSION="0.57.1"

          sudo apt-get update
          sudo apt-get install -y wget tar

          wget -q "https://github.com/aquasecurity/trivy/releases/download/v${TRIVY_VERSION}/trivy_${TRIVY_VERSION}_Linux-64bit.tar.gz" -O /tmp/trivy.tgz
          tar -xzf /tmp/trivy.tgz -C /tmp trivy
          sudo install -m 0755 /tmp/trivy /usr/local/bin/trivy
          trivy --version

      - name: Trivy - Vulnerabilities (fs) -> SARIF
        shell: bash
        run: |
          set -euo pipefail
          trivy fs \
            --scanners vuln \
            --severity HIGH,CRITICAL \
            --ignore-unfixed \
            --format sarif \
            --output trivy-vuln.sarif \
            .

      - name: Upload SARIF (vuln) to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-vuln.sarif
          category: trivy-vuln

      - name: Trivy - Secrets -> SARIF
        shell: bash
        run: |
          set -euo pipefail
          trivy fs \
            --scanners secret \
            --format sarif \
            --output trivy-secret.sarif \
            .

      - name: Upload SARIF (secret) to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-secret.sarif
          category: trivy-secret

      - name: Trivy - IaC Config -> SARIF
        shell: bash
        run: |
          set -euo pipefail
          trivy config \
            --severity HIGH,CRITICAL \
            --format sarif \
            --output trivy-config.sarif \
            .

      - name: Upload SARIF (config) to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-config.sarif
          category: trivy-config
